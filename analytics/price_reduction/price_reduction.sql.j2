{%- import 'dimensions.macro.sql.j2' as dimensions %}
{%- import 'groupbys.macro.sql.j2' as groupbys %}
{%- import 'filters.macro.sql.j2' as filters %}

SELECT
    {{ dimensions.date('DATE(MajorChangeTimeStamp)', level) }}
    {{ dimensions.breakdown(by) }}
    COUNT(ListingId) AS count_units,
    AVG(DATEDIFF(DATE(MajorChangeTimeStamp), OnMarketDate, day) + 1) AS avg_time_to_discount_in_days,
    AVG(ListPrice - PreviousListPrice) AS price_reduction,
FROM
    MLSGrid.Property
WHERE
    1 = 1
    AND MajorChangeType = 'Price Change'
    AND MlsStatus in (
        'Active',
        'Coming Soon / Hold', 
        'Under Contract - Showing',
        'Under Contract - Not Showing',
        'Closed'
    )
    {{ filters.market_date(start, end) }}
    {{ filters.geo(country, city) }}
GROUP BY
    {{ groupbys.date('DATE(MajorChangeTimeStamp)', level) }}
    {{ groupbys.breakdown(by) }}

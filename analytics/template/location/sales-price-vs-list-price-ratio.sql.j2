{%- import 'macro/dimensions.sql.j2' as dimensions %}
{%- import 'macro/groupbys.sql.j2' as groupbys %}
{%- import 'macro/filters.sql.j2' as filters %}

SELECT
    {{ dimensions.date('CloseDate', level) }}
    PERCENTILE_CONT(ClosePrice , 0.5) OVER (PARTITION BY CloseDate) AS median_close_price,
    PERCENTILE_CONT(OriginalListPrice , 0.5) OVER (PARTITION BY CloseDate) AS median_list_price,
    AVG(
        SAFE_DIVIDE(
            PERCENTILE_CONT(ClosePrice , 0.5) OVER (PARTITION BY CloseDate),
            PERCENTILE_CONT(OriginalListPrice , 0.5) OVER (PARTITION BY CloseDate)
        )
    ) AS ratio
FROM
    MLSGrid.Property
WHERE
    {{ filters.mls_status_closed() }}
    AND {{ filters.close_date(start, end) }}
    AND {{ filters.geo(country, city) }}
GROUP BY
    {{ groupbys.date('CloseDate', level) }}

